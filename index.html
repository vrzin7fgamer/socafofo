<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jogo da Velha Online</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#001f4d,#ff0000);
  display:flex;
  justify-content:center;
  padding:20px;
  color:white;
}

.container{
  width:100%;
  max-width:500px;
  background:rgba(255,255,255,0.1);
  padding:20px;
  border-radius:20px;
}

.board{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin:15px 0;
  transition:transform 0.5s ease;
}

.cell{
  aspect-ratio:1;
  background:rgba(255,255,255,0.2);
  border-radius:15px;
  font-size:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:background 0.3s ease, box-shadow 0.3s ease;
}

.cell:hover{
  background:rgba(255,255,255,0.3);
}

.cell.clicked{
  animation:fadeIn 0.5s ease;
}

.cell.win{
  animation:pulseGreen 1s infinite;
  box-shadow:0 0 20px green;
}

.cell.lose{
  animation:shakeRed 0.5s infinite;
  box-shadow:0 0 20px red;
}

.board.tie{
  animation:spin 3s ease;
  background:yellow;
  border-radius:15px;
}

@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}

@keyframes pulseGreen{
  0%,100%{background:rgba(0,255,0,0.5);}
  50%{background:rgba(0,255,0,1);}
}

@keyframes shakeRed{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}

@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

#messages{
  height:120px;
  overflow-y:auto;
  background:rgba(0,0,0,0.3);
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

input,button{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:10px;
  border:none;
}

button{
  background:white;
  font-weight:bold;
  cursor:pointer;
}

#shareLink{
  background:rgba(255,255,255,0.2);
  padding:10px;
  border-radius:10px;
  word-break:break-all;
  margin:10px 0;
}

#resetBtn{
  display:none;
  margin-top:10px;
}

#score{
  font-size:14px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="container">

<h2>ðŸ”¥ Jogo da Velha Online ðŸ”¥</h2>

<input id="nameInput" placeholder="Seu nome">
<button onclick="joinRoom()">Entrar e Criar/Entrar na Sala</button>

<div id="shareSection" style="display:none;">
  <p>Compartilhe este link com seu amigo:</p>
  <div id="shareLink"></div>
  <button onclick="copyLink()">Copiar Link</button>
</div>

<div id="score">Placar: X:0, O:0, Empates:0</div>
<h3 id="status">Digite seu nome e clique em Entrar...</h3>

<div class="board" id="board"></div>

<button id="resetBtn" onclick="resetGame()">Jogar Novamente</button>
<button onclick="startNewGame()">Nova Partida</button>

<h3>ðŸ’¬ Chat</h3>
<div id="messages"></div>
<input id="messageInput" placeholder="Digite mensagem">
<button onclick="sendMessage()">Enviar</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue, onChildChanged, push, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBAO358MTNVV5jZEPx1480YM6QjPaiiNKE",
  authDomain: "jogo-da-velha-93ab2.firebaseapp.com",
  databaseURL: "https://jogo-da-velha-93ab2-default-rtdb.firebaseio.com",
  projectId: "jogo-da-velha-93ab2",
  storageBucket: "jogo-da-velha-93ab2.firebasestorage.app",
  messagingSenderId: "759746631284",
  appId: "1:759746631284:web:61e13ef8073fb21807e321"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let roomId, playerSymbol, playerName, lastMessageTime = 0, score = {X:0, O:0, Empates:0}, lastActivity = Date.now(), winningCells = [], countdownInterval;

const boardDiv = document.getElementById("board");
for(let i=0;i<9;i++){
  const cell=document.createElement("div");
  cell.className="cell";
  cell.onclick=()=>makeMove(i);
  boardDiv.appendChild(cell);
}

// Fallback para aspect-ratio em navegadores antigos
if (!CSS.supports('aspect-ratio: 1')) {
  document.querySelectorAll('.cell').forEach(cell => {
    cell.style.paddingBottom = '100%';
    cell.style.height = '0';
  });
}

// Sons de memes brasileiros engraÃ§ados (sintetizados)
function playMemeSound(type) {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);

  if (type === 'X') {
    oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(400, audioCtx.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime + 0.2);
    oscillator.type = 'sawtooth';
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5);
  } else if (type === 'O') {
    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(400, audioCtx.currentTime + 0.2);
    oscillator.type = 'square';
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.7);
  } else if (type === 'win') {
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        oscillator.frequency.setValueAtTime(500 + i * 100, audioCtx.currentTime + i * 0.2);
        oscillator.type = 'triangle';
        oscillator.start(audioCtx.currentTime + i * 0.2);
        oscillator.stop(audioCtx.currentTime + i * 0.2 + 0.3);
      }, i * 200);
    }
  } else if (type === 'lose') {
    oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(250, audioCtx.currentTime + 0.2);
    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime + 0.4);
    oscillator.type = 'sawtooth';
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 1);
  } else if (type === 'tie') {
    oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(400, audioCtx.currentTime + 0.3);
    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime + 0.6);
    oscillator.type = 'sawtooth';
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 1.2);
  }
}

// Gera ID de sala automaticamente ou pega da URL
function getRoomId() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('room') || (Date.now() + Math.random().toString(36).substr(2, 9));
}

window.joinRoom = async function(){
  playerName = document.getElementById("nameInput").value;
  if (!playerName) return alert("Digite seu nome!");

  roomId = getRoomId();
  console.log("Room ID gerado/usado:", roomId);

  const roomRef = ref(db, "rooms/" + roomId);
  try {
    const snapshot = await get(roomRef);
    console.log("Snapshot exists:", snapshot.exists());

    if (!snapshot.exists()) {
      console.log("Criando nova sala...");
      await set(roomRef, {
        board: ["","","","","","","","",""],
        turn: "X",
        winner: null,
        players: { X: playerName },
        score: {X:0, O:0, Empates:0},
        lastActivity: Date.now()
      });
      playerSymbol = "X";
    } else {
      const data = snapshot.val();
      console.log("Sala existente, dados:", data);
      if (data.players && data.players.O) {
        return alert("Sala cheia! Use 'Nova Partida' para criar uma nova sala.");
      }
      await update(roomRef, { players: { ...data.players, O: playerName }, lastActivity: Date.now() });
      playerSymbol = "O";
      score = data.score || {X:0, O:0, Empates:0};
    }

    // onDisconnect
    onDisconnect(roomRef).update({ players: null, lastActivity: Date.now() });

    // Mostra link compartilhÃ¡vel se criou a sala
    if (playerSymbol === "X") {
      const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
      document.getElementById("shareLink").innerText = link;
      document.getElementById("shareSection").style.display = "block";
    }

    document.getElementById("status").innerText = "VocÃª Ã© " + playerSymbol;
    updateScore();

    // Listeners otimizados
    onChildChanged(roomRef, (snap) => {
      const key = snap.key;
      const val = snap.val();
      if (key === 'board') {
        document.querySelectorAll(".cell").forEach((c, i) => {
          c.innerText = val[i];
        });
      } else if (key === 'turn' || key === 'winner') {
        const data = snap.val();
        if (data.winner) {
          status.innerText = data.winner === "Empate" ? "Empate!" : "Vencedor: " + data.winner;
          playMemeSound(data.winner === "Empate" ? 'tie' : (data.winner === playerSymbol ? 'win' : 'lose'));
          document.getElementById("resetBtn").style.display = "block";
          if (data.winner === "Empate") score.Empates++;
          else score[data.winner]++;
          updateScore();
          // AnimaÃ§Ãµes de fim de jogo
          if (data.winner === "Empate") {
            boardDiv.classList.add("tie");
            setTimeout(() => boardDiv.classList.remove("tie"), 3000);
          } else {
            winningCells.forEach(i => {
              const cell = document.querySelectorAll(".cell")[i];
              cell.classList.add(data.winner === playerSymbol ? "win" : "lose");
            });
            setTimeout(() => {
              document.querySelectorAll(".cell").forEach(c => c.classList.remove("win", "lose"));
            }, 3000);
          }
          // ReinÃ­cio automÃ¡tico em 5s
          startCountdown();
        } else {
          status.innerText = data.turn === playerSymbol ? "Sua vez" : "Esperando o outro jogador...";
        }
      } else if (key === 'lastActivity') {
        lastActivity = val;
        checkConnection();
      }
    });

    onValue(ref(db, "rooms/" + roomId + "/chat"), (snap) => {
      messages.innerHTML = "";
      const chat = snap.val() || {};
      const msgs = Object.values(chat).slice(-20);
      msgs.forEach(msg => {
        messages.innerHTML += `<div>${msg}</div>`;
      });
      messages.scrollTop = messages.scrollHeight;
    });
  } catch (error) {
    console.error("Erro ao entrar na sala:", error);
    alert("Erro de rede. Tente recarregar a pÃ¡gina.");
  }
}

window.makeMove = async function(i){
  if (Date.now() - lastActivity > 30000) return alert("Jogador desconectado!");
  const roomRef = ref(db, "rooms/" + roomId);
  const snap = await get(roomRef);
  const data = snap.val();

  if (!data || data.turn !== playerSymbol || data.board[i]) return;

  data.board[i] = playerSymbol;
  data.turn = playerSymbol === "X" ? "O" : "X";
  data.winner = checkWinner(data.board);
  data.lastActivity = Date.now();

  await update(roomRef, data);
  playMemeSound(playerSymbol);
  document.querySelectorAll(".cell")[i].classList.add("clicked");
  setTimeout(() => document.querySelectorAll(".cell")[i].classList.remove("clicked"), 500);
}

function checkWinner(b) {
  const combos = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for (let c of combos) {
    if (b[c[0]] && b[c[0]] === b[c[1]] && b[c[0]] === b[c[2]]) {
      winningCells = c;
      return b[c[0]];
    }
  }
  if (b.every(cell => cell !== "")) return "Empate";
  return null;
}

window.sendMessage = function(){
  if (!messageInput.value || Date.now() - lastMessageTime < 1000) return;
  lastMessageTime = Date.now();
  const timestamp = new Date().toLocaleTimeString();
  push(ref(db, "rooms/" + roomId + "/chat"), `${playerName} (${timestamp}): ${messageInput.value}`);
  messageInput.value = "";
}

window.resetGame = async function(){
  const password = prompt("Digite a senha para reiniciar:");
  if (password !== "2026") return alert("Senha incorreta!");
  clearInterval(countdownInterval);
  const roomRef = ref(db, "rooms/" + roomId);
  await update(roomRef, {
    board: ["","","","","","","","",""],
    turn: "X",
    winner: null,
    lastActivity: Date.now()
  });
  document.getElementById("resetBtn").style.display = "none";
  document.getElementById("status").innerText = "Jogo reiniciado! VocÃª Ã© " + playerSymbol;
  boardDiv.classList.remove("tie");
  document.querySelectorAll(".cell").forEach(c => c.classList.remove("win", "lose"));
}

window.startNewGame = async function(){
  const password = prompt("Digite a senha para nova partida:");
  if (password !== "2026") return alert("Senha incorreta!");
  clearInterval(countdownInterval);
  const newRoomId = Date.now() + Math.random().toString(36).substr(2, 9);
  const newLink = `${window.location.origin}${window.location.pathname}?room=${newRoomId}`;
  window.location.href = newLink;
}

function startCountdown() {
  let count = 5;
  countdownInterval = setInterval(() => {
    document.getElementById("status").innerText = `Reiniciando em ${count}...`;
    count--;
    if (count < 0) {
      clearInterval(countdownInterval);
      resetGameAuto();
    }
  }, 1000);
}

async function resetGameAuto() {
  const roomRef = ref(db, "rooms/" + roomId);
  await update(roomRef, {
    board: ["","","","","","","","",""],
    turn: "X",
    winner: null,
    lastActivity: Date.now()
  });
  document.getElementById("resetBtn").style.display = "none";
  document.getElementById("status").innerText = "Jogo reiniciado! VocÃª Ã© " + playerSymbol;
  boardDiv.classList.remove("tie");
  document.querySelectorAll(".cell").forEach(c => c.classList.remove("win", "lose"));
}

function updateScore() {
  document.getElementById("score").innerText = `Placar: X:${score.X}, O:${score.O}, Empates:${score
